#!/usr/bin/env php
<?php

$container = require (__DIR__.'/../bootstrap.php');

use App\Commands\CommandAbstract;
use Cron\CronExpression;

$cli = $container->get('cli');
$commandGenerator = $container->get('commandGenerator');
/**
 * @var \Symfony\Component\Console\Application $cli
 * @var \App\Services\CommandGenerator $commandGenerator
 */
$time = time();

foreach ($cli->all() as $command) {
    if ($command instanceof CommandAbstract)
    {
        $expression = $command->shedule();
        try {
            $cron = CronExpression::factory($expression);
        } catch (InvalidArgumentException $e) {
            continue;
        }
        if ($cron->isDue()) {
            $run = $commandGenerator->createCommand($command->getName());
            $run .= ' > /dev/null 2>&1 &';
            exec($run);
        }
    }
}